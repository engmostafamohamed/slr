name: Deploy Laravel 11 to AWS EB

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      # Generate .ebextensions for Elastic Beanstalk
      - name: Create EB configurations
        run: |
          mkdir -p .ebextensions
          
          echo "option_settings:
            aws:elasticbeanstalk:application:environment:
              APP_ENV: production
              APP_DEBUG: false
              LOG_CHANNEL: stderr
              DB_CONNECTION: mysql
              DB_HOST: ${DB_HOST}
              DB_PORT: 26130
              DB_DATABASE: ${DB_DATABASE}
              DB_USERNAME: ${DB_USERNAME}
              DB_PASSWORD: ${DB_PASSWORD}
          " > .ebextensions/01-environment.config

          echo "container_commands:
            01_storage_permissions:
              command: \"chmod -R 755 storage\"
              ignoreErrors: false
          " > .ebextensions/02-permissions.config

          echo "container_commands:
            01_run_migrations:
              command: \"php artisan migrate --force\"
              leader_only: true
            02_optimize:
              command: \"php artisan optimize\"
          " > .ebextensions/03-migrations.config

      # Setup PHP
      - name: Setup PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'
          extensions: mbstring, ctype, fileinfo, openssl, tokenizer, xml, gd, pdo_mysql

      # Install Composer dependencies
      - name: Install dependencies
        run: |
          composer install --no-dev --optimize-autoloader
          php artisan config:clear
          php artisan route:clear
          php artisan view:clear
          php artisan cache:clear

      - name: Set directory permissions
        run: chmod -R 775 storage bootstrap/cache

      # Package app
      - name: Create deployment package
        run: |
          rm -rf node_modules/ .git/ .github/
          zip -r ../app.zip . -x '*.git*' '*.env*'

      # Set AWS credentials
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY_ID }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_ACCESS_KEY }}
          aws-region: ${{ secrets.AWS_REGION }}

      # Deploy to Elastic Beanstalk
      - name: Deploy to Elastic Beanstalk
        uses: einaregilsson/beanstalk-deploy@v21
        with:
          application_name: ${{ secrets.AWS_ELASTICBEANSTALK_APPLICATION_NAME }}
          environment_name: ${{ secrets.AWS_ELASTICBEANSTALK_ENVIRONMENT_NAME }}
          version_label: "v${{ github.run_number }}"
          region: ${{ secrets.AWS_REGION }}
          deployment_package: ../app.zip
